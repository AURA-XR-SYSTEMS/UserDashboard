<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Aura — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/styles.css">
</head>
<body>
  <header class="header">
    <nav class="nav">
      <div class="brand"><a href="/dashboard"><img class="brand-logo" src="/assets/aura_logo_withtext_transparent_white-06.png" alt="Aura" /></a></div>
      <div class="right">
        <a class="btn ghost" href="/account">Account</a>
        <a class="btn ghost" href="/docs">Documentation</a>
        <a class="btn ghost" href="/downloads">Downloads</a>
        <button class="btn" data-logout>Log out</button>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Welcome, <span data-username>user</span></h1>
      <p class="muted">Your unified portal for access keys, downloads, documentation, and billing.</p>
    </section>

    <div class="home-row first">
      <div class="card has-header" id="status-panel">
        <div class="card-header">Status</div>
        <div class="card-body">
          <div class="features" style="display:flex; flex-direction:column; gap:12px;">
            <div id="status-chips">Loading status…</div>
            <div id="credits-block" style="display:none;">
              <div class="row" style="justify-content:space-between;">
                <span class="badge">Credits</span>
                <span class="badge" id="credits-label"></span>
              </div>
              <div class="meter" aria-label="included credits"><span id="credits-meter"></span></div>
              <div class="row" style="justify-content:space-between; margin-top:8px;">
                <span class="badge">Additional credits</span>
                <span class="badge" id="purchased-label">0 / 0 this cycle</span>
              </div>
              <div class="meter blue" aria-label="purchased credits"><span id="purchased-meter"></span></div>
              <div class="card-actions" style="margin-top:10px;">
                <a class="btn ghost" href="/credits">Purchase credits</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card has-header">
        <div class="card-header">Quick actions</div>
        <div class="card-body">
          <div class="features" style="display:flex; flex-direction:column; gap:10px;">
            <div class="card-actions">
              <a class="btn primary" href="/downloads">Go to downloads</a>
              <a class="btn ghost" href="/account">Account settings</a>
              <a class="btn ghost" href="/account" onclick="event.preventDefault(); location.href='/account'">Manage billing</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="home-row second">
      <div class="card has-header">
        <div class="card-header">Get started</div>
        <div class="card-body">
          <div class="features">
            <ol style="margin:0; padding-left:18px;">
              <li>Choose a plan</li>
              <li>Download tools</li>
              <li>Read setup guide</li>
            </ol>
            <div class="card-actions" style="margin-top:12px;">
              <a class="btn primary" href="/plans">Choose a plan</a>
              <a class="btn ghost" href="/downloads" data-requires-plan>Go to downloads</a>
            </div>
          </div>
        </div>
      </div>
      <div class="card has-header">
        <div class="card-header">Documentation</div>
        <div class="card-body">
          <div class="features">Read setup guides, API references, and tutorials.</div>
          <div class="card-actions">
            <a class="btn ghost" href="/docs">Open documentation</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer"><span>© 2025 Aura XR Systems LLC</span><span>Dashboard</span></footer>
  <script src="/public/app.js"></script>
  <script>
    // Populate status summary with chips and credits meter
    (async function(){
      try{
        const { user } = await (await fetch('/api/me')).json();
        const chipsEl = document.getElementById('status-chips');
        if (!user || !user.billing || user.billing.status === 'none') {
          chipsEl.innerHTML = 'No active plan. <a href="/plans">Choose a plan</a> to unlock downloads.';
        } else {
          const renew = user.billing.renewAt ? new Date(user.billing.renewAt).toLocaleDateString() : '—';
          const statusClass = user.billing.status === 'active' ? 'success' : 'warn';
          chipsEl.innerHTML = `
            <div class="row" style="flex-wrap:wrap; gap:8px;">
              <span class="chip">Plan: <strong>${user.billing.planId || '—'}</strong></span>
              <span class="chip ${statusClass}">Status: <strong>${user.billing.status}</strong></span>
              <span class="chip muted">Renews: <strong>${renew}</strong></span>
            </div>
          `;
        }

        // Credits block
        const creditsBlock = document.getElementById('credits-block');
        const creditsLabel = document.getElementById('credits-label');
        const creditsMeter = document.getElementById('credits-meter');
        const purchasedLabel = document.getElementById('purchased-label');
        const purchasedMeter = document.getElementById('purchased-meter');
        if (user && user.credits && typeof user.credits.balance === 'number'){
          const bal = user.credits.balance;
          const incl = typeof user.credits.includedAllowance === 'number' ? user.credits.includedAllowance : 0;
          const incBal = typeof user.credits.includedRemaining === 'number' ? user.credits.includedRemaining : Math.min(bal, incl);
          const purBal = typeof user.credits.purchasedRemaining === 'number' ? user.credits.purchasedRemaining : Math.max(0, bal - incBal);
          const purTotal = typeof user.credits.purchasedCycleTotal === 'number' ? user.credits.purchasedCycleTotal : purBal;
          if (incl > 0){
            const pct = Math.max(0, Math.min(100, (incBal / incl) * 100));
            creditsMeter.style.width = pct + '%';
            creditsLabel.textContent = `${incBal.toLocaleString()} / ${incl.toLocaleString()} included this cycle`;
          } else {
            creditsLabel.textContent = `${bal.toLocaleString()} available`;
            creditsMeter.style.width = '0%';
          }
          const pPct = purTotal>0 ? Math.max(0, Math.min(100, (purBal / purTotal) * 100)) : 0;
          purchasedMeter.style.width = pPct + '%';
          purchasedLabel.textContent = `${purBal.toLocaleString()} / ${purTotal.toLocaleString()} this cycle`;
          creditsBlock.style.display = 'block';
        }
      }catch(e){}
    })();
  </script>
</body>
</html>
